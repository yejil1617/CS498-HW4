from pyspark.sql import SparkSession
import pandas

# Initialize Spark session
spark = SparkSession \
    .builder \
    .appName("Search Log") \
    .getOrCreate()

# Read the search.log file
file_path = "searchLog.csv"

# Parse the log file
parsed_data = []
with open(file_path, 'r') as file:
    for line in file:
        line = line.strip()
        # Split the line into search term and url:click pairs
        parts = line.split(",")
            
        term = parts[0].replace("searchTerm: ", "")
        term = term.replace("‘", "").replace("’", "")

        pairs = parts[1].split("~")
        
        for pair in pairs:
            url_click = pair.split(":")
            if len(url_click) == 2:
                url = url_click[0]
                clicks = int(url_click[1])
                parsed_data.append((term, url, clicks))


columns = ["term", "url", "clicks"] 
# Create DataFrame from the parsed data
df = spark.createDataFrame(parsed_data, columns)

# # Create output directory if it doesn't exist
# output_dir = "processed_data"
# if not os.path.exists(output_dir):
#     os.makedirs(output_dir)

# # Save DataFrame as JSON files
# df.write.json(output_dir, mode="overwrite")
df.toPandas().to_json('processed_data.json', orient='records', force_ascii=False, lines=True)

# Stop Spark session
spark.stop()

print(f"Data successfully processed and saved")





from flask import Flask, request, jsonify
from pyspark.sql import SparkSession
from pyspark.sql.functions import sum as spark_sum, col, count
import re
from urllib.parse import urlparse

app = Flask(__name__)

# Initialize Spark session
spark = SparkSession \
    .builder \
    .appName("Search Log") \
    .getOrCreate()

df = spark.read.json("processed_data.json")
df.createOrReplaceTempView("search_data")

def get_domain_priority(url):
    """Helper function to determine domain priority for sorting"""
    domain = urlparse(url).netloc
    if domain.endswith('.org'):
        return 0
    elif domain.endswith('.edu'):
        return 1
    elif domain.endswith('.com'):
        return 2
    else:
        return 3

@app.route('/', methods=['GET'])
def hello_cloud():
  return 'hello'

@app.route('/results', methods=['POST'])
def get_results():
    data = request.get_json()
    search_term = data.get('term', '')
    
    if not df:
        return jsonify({"error": "Data not loaded"}), 500
    
    # Query for the search term
    results_df = spark.sql(f"""
        SELECT url, SUM(clicks) as total_clicks
        FROM search_data
        WHERE term = '{search_term}'
        GROUP BY url
        ORDER BY total_clicks DESC
    """).collect()
    
    # Convert to dictionary and sort by clicks and domain priority
    results = {row['url']: row['total_clicks'] for row in results_df}
    sorted_results = dict(sorted(results.items(), 
                               key=lambda item: (-item[1], get_domain_priority(item[0]))))
    
    return jsonify({"results": sorted_results})

@app.route('/popularity', methods=['POST'])
def get_popularity():
    data = request.get_json()
    url = data.get('url', '')
    
    if not df:
        return jsonify({"error": "Data not loaded"}), 500
    
    total_clicks = spark.sql(f"""
        SELECT SUM(clicks) as total
        FROM search_data
        WHERE url = '{url}'
    """).collect()[0]['total']
    
    return jsonify({"clicks": total_clicks})

@app.route('/getBestTerms', methods=['POST'])
def get_best_terms():
    data = request.get_json()
    website = data.get('website', '')
    
    if not df:
        return jsonify({"error": "Data not loaded"}), 500
    
    # Get total clicks for the website
    total_website_clicks = spark.sql(f"""
        SELECT SUM(clicks) as total
        FROM search_data
        WHERE url = '{website}'
    """).collect()[0]['total']
    
    if not total_website_clicks:
        return jsonify({"best_terms": []})
    
    # Get terms where clicks for this website are >5% of total website clicks
    threshold = 0.05 * total_website_clicks
    
    best_terms_df = spark.sql(f"""
        SELECT term, SUM(clicks) as term_clicks
        FROM search_data
        WHERE url = '{website}'
        GROUP BY term
        HAVING term_clicks > {threshold}
    """).collect()
    
    best_terms = [row['term'] for row in best_terms_df]
    
    return jsonify({"best_terms": best_terms})

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8080, debug=True)

@app.route('/trends', methods=['POST'])
def get_trends():
    data = request.get_json()
    search_term = data.get('term', '')
    
    if not df:
        return jsonify({"error": "Data not loaded"}), 500
    
    total_clicks = spark.sql(f"""
        SELECT SUM(clicks) as total
        FROM search_data
        WHERE term = '{search_term}'
    """).collect()[0]['total']
    
    return jsonify({"clicks": total_clicks})

@app.route('/popularity', methods=['POST'])
def get_popularity():
    data = request.get_json()
    url = data.get('url', '')
    
    if not df:
        return jsonify({"error": "Data not loaded"}), 500
    
    total_clicks = spark.sql(f"""
        SELECT SUM(clicks) as total
        FROM search_data
        WHERE url = '{url}'
    """).collect()[0]['total']
    
    return jsonify({"clicks": total_clicks})

@app.route('/getBestTerms', methods=['POST'])
def get_best_terms():
    data = request.get_json()
    website = data.get('website', '')
    
    if not df:
        return jsonify({"error": "Data not loaded"}), 500
    
    # Get total clicks for the website
    total_website_clicks = spark.sql(f"""
        SELECT SUM(clicks) as total
        FROM search_data
        WHERE url = '{website}'
    """).collect()[0]['total']
    
    if not total_website_clicks:
        return jsonify({"best_terms": []})
    
    # Get terms where clicks for this website are >5% of total website clicks
    threshold = 0.05 * total_website_clicks
    
    best_terms_df = spark.sql(f"""
        SELECT term, SUM(clicks) as term_clicks
        FROM search_data
        WHERE url = '{website}'
        GROUP BY term
        HAVING term_clicks > {threshold}
    """).collect()
    
    best_terms = [row['term'] for row in best_terms_df]
    
    return jsonify({"best_terms": best_terms})

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8080, debug=True)
